@page
@using Microsoft.AspNetCore.Http
@using WebHomePro.Services
@model WebHomePro.Pages.Cliente.MenuclienteModel
@inject ProveedorService2 Prov
@{
    Layout = null;

    var prepago = new List<LineaPrepagoVm>();
    var postpago = new List<LineaPostpagoVm>();
    string error = string.Empty;
    try
    {
        prepago = await Prov.GetLineasPrepagoAsync();
        postpago = await Prov.GetLineasPostpagoAsync();
    }
    catch (System.Exception ex)
    {
        error = "No fue posible cargar tus líneas. " + ex.Message;
    }
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>HomePro - Menú Cliente</title>
    <link rel="icon" type="image/x-icon" href="~/assets/favicon.ico" />

    <!-- Font Awesome icons -->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>

    <!-- Google fonts -->
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" />

    <!-- Theme CSS -->
    <link href="~/css/StyleMenuAdmin.css" rel="stylesheet" />
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" asp-page="/Index">
                <img src="~/img/LOGO HOMEPRO.png" alt="Logo" style="height: 5rem;" />
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive">
                Menu <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto py-4 py-lg-0">
                    <!-- Saludo al cliente -->
                    <li class="nav-item">
                        <span class="navbar-text px-lg-3 py-3 py-lg-4">
                            Hola @HttpContext.Session.GetString("ClienteNombre")
                        </span>
                    </li>

                    <!-- Opciones del menú -->
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" asp-page="/Cliente/Lineas">Líneas Activas a su Nombre</a></li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" asp-page="">Cargar saldo a línea PREPAGO</a></li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" asp-page="">Pago facturas pendientes</a></li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" asp-page="/Cliente/DevolverLineaCliente">Devolver una Línea</a></li>
                    <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" asp-page="/Login">Salir del Sitio</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <header class="masthead" style="background-image: url('@Url.Content("~/img/home-bg.jpg")')">
        <div class="container position-relative px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-7">
                    <div class="site-heading">
                        <h1>Lineas activas a su nombre</h1>
                        <span class="subheading">Gestioná tu contenido fácilmente</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Tablas -->
    <section class="py-5">
        <div class="container px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-7">

                    @if (!string.IsNullOrWhiteSpace(error))
                    {
                        <div class="alert alert-danger">@error</div>
                    }

                    <h3 class="mb-3">Líneas Prepago</h3>
                    @if (prepago == null || prepago.Count == 0)
                    {
                        <div class="alert alert-info">No tienes líneas prepago registradas.</div>
                    }
                    else
                    {
                        <table id="prepago" class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Teléfono</th>
                                    <th class="text-end">Saldo disponible</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-prepago">
                                @foreach (var l in prepago)
                                {
                                    <tr data-tel="@l.Telefono">
                                        <td>@l.Telefono</td>
                                        <td class="text-end">@l.SaldoDisponible.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                    <hr class="my-4" />

                    <h3 class="mb-3">Líneas Postpago</h3>
                    @if (postpago == null || postpago.Count == 0)
                    {
                        <div class="alert alert-info">No tienes líneas postpago registradas.</div>
                    }
                    else
                    {
                        <table id="postpago" class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Teléfono</th>
                                    <th class="text-end">Monto pendiente</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-postpago">
                                @foreach (var l in postpago)
                                {
                                    <tr data-tel="@l.Telefono" data-monto="@l.MontoPendiente">
                                        <td>@l.Telefono</td>
                                        <td class="text-end">@l.MontoPendiente.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }

                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="border-top">
        <div class="container px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-7">
                    <div class="small text-center text-muted fst-italic">Derechos Reservados &copy; HomePro 2025</div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/scripts.js"></script>

    <script>

        window.addEventListener('linea-devuelta', () => {
            try {
                const raw = localStorage.getItem('lineaDevuelta');
                if (!raw) return;
                const data = JSON.parse(raw);
                if (!data || !data.tel) return;
                // refrescar tablas desde el servidor (HTML parcial)
                refrescarTablas();
            } catch { /* ignore */ }
        });

        // 2) Doble clics (como tenías)
        var navegarCliente5 = false;
        var navegarCliente6 = false;

        (function () {
            // PREPAGO
            document.querySelectorAll('#prepago tbody tr').forEach(function (tr) {
                tr.addEventListener('dblclick', function () {
                    var tel = tr.getAttribute('data-tel');
                    if (navegarCliente5) {
                        window.location.href = '' + encodeURIComponent(tel);
                    } else {
                        alert('Doble clic en PREPAGO (' + tel + '). Navegación deshabilitada (CLIENTE5 no creado).');
                    }
                });
            });

            // POSTPAGO
            document.querySelectorAll('#postpago tbody tr').forEach(function (tr) {
                tr.addEventListener('dblclick', function () {
                    var tel = tr.getAttribute('data-tel');
                    var monto = parseFloat(tr.getAttribute('data-monto') || '0');
                    if (monto <= 0) {
                        alert('Esta línea no tiene facturación pendiente.');
                        return;
                    }
                    if (navegarCliente6) {
                        window.location.href = '' + encodeURIComponent(tel);
                    } else {
                        alert('Doble clic en POSTPAGO (' + tel + ') con monto ' + monto.toFixed(2) +
                            '. Navegación deshabilitada (CLIENTE6 no creado).');
                    }
                });
            });
        })();

        // 3) Función que pide HTML parcial y re-renderiza ambos <tbody>
        async function refrescarTablas() {
            try {
                const resp = await fetch('@Url.Page("/Cliente/Lineas", "LineasParciales")', {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!resp.ok) return;
                const html = await resp.text();
                // El parcial devuelve dos contenedores <template> con los tbodys
                const tpl = document.createElement('div');
                tpl.innerHTML = html;

                const nuevoPrepago = tpl.querySelector('#tpl-prepago');
                const nuevoPostpago = tpl.querySelector('#tpl-postpago');

                if (nuevoPrepago) {
                    document.querySelector('#tbody-prepago').innerHTML = nuevoPrepago.innerHTML;
                }
                if (nuevoPostpago) {
                    document.querySelector('#tbody-postpago').innerHTML = nuevoPostpago.innerHTML;
                }
            } catch (e) {
                console.error(e);
            }
        }
    </script>
</body>
</html>